# 集群启动流程

## 选举主节点（ElectMasterService.java）

一般情况下，第一个启动的节点是主节点，然后之后的流程由主节点去触发

Elasticsearch 的选主算法是基于 Bully 算法的改进，主要思路是对节点 ID 排序， **取 ID 最大的节点作为 Master，选主完成后想办法把最新的机器元数据复制到选举出主节点上**



### 选举算法有三个附加约定条件

* 参选数需要过半
  * 进入选举临时的 Master 之前，选举的节点数需要达到法定人数（ discovery.zen.minimum_master_nodes=(master_eligible_nodes)/2+1 ）
* 得票数需过半
  * 由于网络延时，可能集群有 ID：1，2，3，4，5。节点 1 读到的集群只有 1，2，3，4，所以会选 4 作为主节点，但是节点 2 读到是 1，3，4，5，所以会选择 5 作为主节点
* 当探测到节点离开事件时，必须判断当前节点数是否过半
  * 当有节点连不上时，会执行 removeNode 操作，接着审视此时的节点法定人数是否大表，不达标就主动放弃 Master 身份执行 rejoin 以避免脑裂

*Elasticsearch 已经在 7 版本之后移除了 minimum_master_nodes 参数*



## 选举集群元信息

被选出的 Master 和集群元信息的新旧程度没有关系。所以它的第一件任务就是选举元信息，让各节点把各自存储的元信息发过来，根据版本号确定最新的元信息，然后把这个信息广播下去，让所有节点都收到最新的元信息集群元信息的选举包括两个级别

* 集群级
* 索引级

例如哪个 shard 存于哪个节点这种信息，这种信息以节点磁盘存储的为准，因为**读写流程是不经过 Master 的，Master 不知道各 shard 副本直接的数据差异**

为了集群的一致性，参与选举的元信息数量需要过半，Master 发布集群状态成功的规则也是等待发布成功的节点数过半

选举过程中，不接收新节点的加入请求

集群元信息选举完毕后，Master 发布首次集群状态，然后开始选举 shard 级元信息



## allocation 过程

选举 shard 级元信息，构建内容路由表，是在 allocation 模块完成的

在初始阶段，所有的 shard 都处于 UNASSIGNED （未分配）状态，ES中通过分配过程决定哪个分片位于哪个节点，重构内容路由表

### 选主分片







