# 字节码指令简介

## 概述

### Java虚拟机

由操作码和操作数组成

* **操作码（Opcode）**
  * **由一个字节长度的、代表着某种特定操作含义的数字**
* **操作数（Operands）**
  * **以及紧跟操作码的零至多个代表此操作所需参数**

Java虚拟机采用面向的操作数栈而不是寄存器的架构，所以大多数指令都不含操作数，只有一个操作码

### 字节码指令集

一种具有鲜明特点、优劣势都很突出的指令集架构

#### 劣势

* 由于限制了 Java 虚拟机操作码的长度为一个字节，这意味着操作码总数不能超过 256 条
  * 由于 Class 文件放弃了编译后代码的操作数长度对齐，这就意味着虚拟机处理那些超过一个字节的数据时，不得不在运行时从字节中重建出具体数据的结构，如果将一个 16 位字节长度的无符号字节存储起来（`byte1`，`byte2`），那么他们的值应该是这样的 -> `（byte1 << 8 | byte2)`，这样做会损失性能

#### 优势

* 放弃了操作数长度对齐，意味着可以省略很多填充和间隔符号
  * 用一个字节来代表操作码，也是尽可能获得短小精干的编译代码。这种尽可能小数据量、高传输效率的设计是由Java语言设计之初面向网络、智能家电的技术背景所决定的，并一直沿用至今

### 基本的执行模型

```java
do {
    自动计算PC寄存器的值加1;
    根据PC寄存器的指示位置，从字节码流中取出操作码;
    if (字节码存在操作数)从字节码流中取出操作数;
    执行操作码所定义的操作;
} while (字节码流长度 > 0);
```

## 字节码与数据类型

指令集中，大多数指令都包含了其操作所对应的数据类型信息。如`iload`指令用于从局部变量表中加载`int`型的数据到操作数栈中，而`aload`指令用于从局部变量表中加载`reference`型数据。

这两条指令的操作在虚拟机中可能会是同一段代码来实现，但在 Class 文件中他们必须拥有各自独立的操作码。

* 大部分与数据类型相关的字节码指令 的操作码助记符中都有特殊的字符来表明专门为哪种数据类型服务

| 数据类型  | 助记符 |
| :-------: | :----: |
|    int    |   i    |
|   long    |   l    |
|   short   |   s    |
|   byte    |   b    |
|   char    |   c    |
|   float   |   f    |
|  double   |   d    |
| reference |   a    |

* 也有一些指令的助记符没有明确的指明操作类型的字母，如`arraylength`指令，它没有代表数据类型的特殊字符，但操作数永远只能是一个数据类型的对象。
* 还有一些指令，如无条件跳转指令`goto`则是与数据类型无关的。

由于 Java 虚拟机的操作码长度只有一个字节，所以包含了数据类型的操作码就为指令集的设计带来很大的压力。因此，**Java虚拟机的指令集对于特定的操作只提供了有限的类型相关指令去支持它**，换句话说，指令集将会故意被设计成非完全独立的（ Java 虚拟机规范中把这种特性称为`Not Orthogonal`，即并非每种数据类型和每一种操作都有相应的指令）。有一些单独的指令可以在必要的时候用来将一些不支持的类型转换为可被支持的类型。

### Java 虚拟机指令集所支持的数据类型

|   opcode   |  byte   |  short  |    int     |  long   |  float  | double  |  char   | reference  |
| :--------: | :-----: | :-----: | :--------: | :-----: | :-----: | :-----: | :-----: | :--------: |
|   Tipush   | bipush  | sipush  |            |         |         |         |         |            |
|   Tconst   |         |         |   iconst   | lconst  | fconst  | dconst  |         |   aconst   |
|   Tload    |         |         |   iload    |  lload  |  fload  |  dload  |         |   aload    |
|   Tstore   |         |         |   istore   | lstore  | fstore  | dstore  |         |   astore   |
|    Tinc    |         |         |    iinc    |         |         |         |         |            |
|   Taload   | baload  | saload  |   iaload   | laload  | faload  | daload  | caload  |   aaload   |
|  Tastore   | bastore | sastore |  iastore   | lastore | fastore | dastore | castore |  aastore   |
|    Tadd    |         |         |    iadd    |  ladd   |  fadd   |  dadd   |         |            |
|    Tsub    |         |         |    isub    |  lsub   |   sub   |  dsub   |         |            |
|    Tmul    |         |         |    imul    |  lmul   |  smul   |  dmul   |         |            |
|    Tdiv    |         |         |    idiv    |  ldiv   |  sdiv   |   div   |         |            |
|    Trem    |         |         |    irem    |  lrem   |  srem   |  drem   |         |            |
|    Tneg    |         |         |    ineg    |  lneg   |  sneg   |  dneg   |         |            |
|    Tshl    |         |         |    ishl    |  lshl   |         |         |         |            |
|    Tshr    |         |         |    ishr    |  lshr   |         |         |         |            |
|   Tushr    |         |         |   iushr    |  lushr  |         |         |         |            |
|    Tand    |         |         |    iand    |  land   |         |         |         |            |
|    Tor     |         |         |    ior     |   lor   |         |         |         |            |
|    Txor    |         |         |    ixor    |  lxor   |         |         |         |            |
|    i2T     |   i2b   |   i2s   |            |   i2l   |   i2f   |   i2d   |         |            |
|    l2T     |         |         |    l2i     |         |   l2f   |   l2d   |         |            |
|    f2T     |         |         |    f2i     |   f2l   |         |   f2d   |         |            |
|    d2T     |         |         |    d2i     |   d2l   |   d2f   |         |         |            |
|    Tcmp    |         |         |            |  lcmp   |         |         |         |            |
|   Tcmpl    |         |         |            |         |  fcmpl  |  dcmpl  |         |            |
|   Tcmpg    |         |         |            |         |  fcmpg  |  dcmpg  |         |            |
| if_TecmpOP |         |         | if_iecmpOP |         |         |         |         | if_aecmpOP |
|  Treturn   |         |         |  ireturn   | lreturn | return  | dreturn |         |  areturn   |

通过使用数据类型列所代表的特殊字符替换 opcode 列的指令模板中的`T`，就可以得到一个具体的字节码指令。如果在表中**指令模板**与**数据类型**两列共同确定的格为空，则说明虚拟机不支持对这种数据类型执行这项操作。

可以看出大部分的指令都没有支持中枢类型的`byte`、`char`和`short`，甚至没有任何指令支持`boolean`类型。编译器会在编译期或运行期将`byte`和`short`类型的数据带符号扩展（ Sign - Extend ）为相应的`int`类型数据，将`boolean`和`char`类型数据零位扩展（ Zero - Extend ）为相应的`int`类型数据。因此。大多数对于`boolean`、`byte`、`short`和`char`类型数据的操作，实际上都是使用相应的`int`类型作为运算类型（Computational Type）。

## 加载和存储指令