# 重排序

## 数据依赖性

数据依赖性分为 3 种类型

| 名称   | 代码示例           | 说明                         |
| ------ | ------------------ | ---------------------------- |
| 写后读 | a = 1;<br />b = a; | 写一个变量之后，再读这个位置 |
| 写后写 | a = 1;<br />a = 2; | 写一个变量之后，再写这个变量 |
| 读后写 | a = b;<br />b = 1; | 读一个变量之后，再写这个变量 |

这里所说的数据依赖性仅针对单个处理器种执行的指令序列，单个线程中执行的操作，不同处理器之间和不同线程之间的数据依赖性不被编译器和处理器考虑



## as-if-serial

语义 - 不管怎么重排序，（单线程）程序的执行结果不能被改变

为了遵守 `as-if-serial` 语义，编译器和处理器不会对存在数据依赖关系的操作做重排序，因为这种重排序会改变执行结果



## 重排序对多线程的影响

```java
class ReorderExample {
    int a = 0;
    boolean flag = false;
    
    public void writer() {
        a = 1;				//1
        flag = true;		//2
    }
    
    public void reader() {
        if (flag) {			//3
            int i = a * a; 	//4
        }
    }
}
```

由于 操作1 和 操作2 之间没有数据依赖关系，所以 操作1 和 操作2 可以重排序

由于 操作3 和 操作4 之间没有数据依赖关系，所以 操作3 和 操作4 可以重排序

> 先将 int temp = a * a;
>
> 如果 flag 为 true 满足，则 i = temp



