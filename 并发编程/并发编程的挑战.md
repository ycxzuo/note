# 挑战

## 上下文切换

单核也支持多线程执行代码，CPU 通过给每个线程分配 CPU 时间片来实现

* 时间片
  * CPU 分配给各个线程的时间，一般是几十毫秒

* 上下文切换
  * CPU 通过时间片分片算法来循环执行任务，当前任务执行一个时间片后切换到下一个任务，但切换前会保存上一个任务状态，以便下次切换回这个任务，可以再加载这个任务的状态

### 上下文切换原因

* 正在执行的任务完成
* 系统 CPU 正常调度
* 当前正在执行的任务遇到 I/O 等阻塞操作，调度器挂起此任务，继续调度下一个任务
* 多个任务并发抢占锁资源，当前任务没有抢到锁资源
* 用户代码挂起当前任务，比如线程执行 sleep/yield 方法，让出时间片
* 硬件中断

### 如何减少

* 无锁并发编程
  * 多线程竞争锁时，会引起上下文切换，所以多线程处理数据时，可以用一些办法来避免使用锁
* CAS 算法
  * Java 的 Atomic 包 使用 CAS 算法来更新数据
* 使用最少线程
  * 避免创建不需要的线程，比如任务很少，但是创建很多线程来处理
* 协程
  * 在单线程里实现多任务调度，在线程内维护多任务间的切换



## 死锁

多个线程被阻塞，他们之间相互等待对方释放资源，就会出现死锁

### 避免死锁方法

* 避免一个线程同时获取多个锁
* 避免一个线程在锁内同时占用多个资源，尽量保证每个锁只占用一个资源
* 尝试使用超时锁
* 保证加锁顺序相同



## 资源限制的挑战

在并发编程时，程序的执行速度受限于计算机硬件资源或软件资源

### 如何解决

* 考虑使用集群
* 资源池