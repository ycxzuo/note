# SpringBoot Starter

SpringBoot Starter 是 SpringBoot 框架中最核心的组件，其中**可能**包含以下组件

* 自动装配模块（Autoconfigure Module）
* 启动器模块（Starter Module）



## 自动装配模块

### 概念

自动装配模块包含类库中的每种必要的启动单元，它可能也包含任意用于未来自定义已初始化组件的回调接口 

* 配置键的定义
  * `@ConfigurationProperties`
* 自定义已初始化组件的回调接口
  * `PropertyMappingContextCustomizer`



### 自动装配类型

* 自动装配 Bean（Auto-Configuration Beans）
  * Spring 配置（`@Configuration`）
  * Srping Boot 管理上下文配置（`ManagementContextConfigutaion`）
* Spring Boot 组件
  * `FailureAnalysisReporter`
  * `SpringApplicationRunListener`
  * `AutoConfigurationImportListener`



### 理解自动装配 Bean

自动装配是由标准 Spring 的 `@Configuration` 实现，结合 Spring4 的新特性条件判断注解 @Conditional 以及其 Spring Boot 派生注解，如 `@ConditionalOnClass` 等



### 放置自动装配 Bean

将标记 `@Configuration` 的Spring Configuration Class 放置在相对于 class-path 的 META-INF/spring.factories 文件中，例如

```properties
org.springframework.context.ApplicationContextInitializer=\
org.springframework.boot.context.ConfigurationWarningsApplicationContextInitializer,\
org.springframework.boot.context.ContextIdApplicationContextInitializer,\
org.springframework.boot.context.config.DelegatingApplicationContextInitializer,\
org.springframework.boot.web.context.ServerPortInfoApplicationContextInitializer
```

对应的功能类是 `SpringFactoryLoader`，其类似于 `ServiceLoader`



### 前置条件（@Conditional）

Bean 装配前的前置条件，基于 Spring4 `@Conditional`，判断当前 Bean 是否适合或者需要装配。在 Spring Boot 场景下，时常使用其派生注解

* 类条件
* Bean 条件
* 配置属性条件
* 资源条件
* Web 应用条件
* Spring 表达式条件

#### 类条件

用于判断指定的 Class 对象或者其全名称存在与否

* 存在判断：`@ConditionOnClass`
* 缺失判断：`@ConditionOnMissClass`

#### Bean 条件

用于判断指定的 Spring Bean 是否在指定的 Spring 应用上下文中存在与否

* 存在判断：`@ConditionalOnBean`
* 却是判断：`@ConditionalOnMissBean`

#### 配置属性条件

用于判断指定的配置属性存在与否，默认是否匹配等

* `@ConditionalOnProperty`

#### 资源条件

用于判断指定的资源是否存在

* `@ConditionalOnResource`，参考 `org.springframework.core.io.Resource`

#### Web 应用条件

用于判断是否是 Web 应用

* `@ConditionalOnWebApplication`

#### Spring 表达式条件

用 Spring 表达式评估结果是否成立

* `@ConditionalOnExpression`



### 自动装配顺序

* 在特定自动装配 Class 之前
  * `@AutoConfigureBefore`
* 在特定自动装配 Class 之前
  * `@AutoConfigureAfter`
* 指定顺序
  * `@AutoConfigureOrder`



## 启动器模块

### 概念

启动器模块是一个空 Jar 文件，仅提供辅助性依赖管理，这些依赖可能用于自动装配或者其他类库

### 特别注意

如果自动装配的类库需要其他启动器（starters），管理依赖时，需要将它们一并引入，最好不用使用单一启动器来间接依赖。提供一种合适依赖管理集合可能非常困难，如果其中类库在非必须依赖时，例如 Spring Boot 官方启动模块：spring-boot-starter:${version}



## 命名

Spring Boot Starter 名称也称之为 Spring Boot 命名空间，通常用语 Maven artifactId，并且能够传达 starter 模块的功能职责。Starter 命名空间可简单的分类为

* 官方命名空间
* 自定义命名空间

### 命名规约

#### 官方命名空间

* 前缀："spring-boot-starter-"
* 模式：spring-boot-starter-{module.name}
* 举例：spring-boot-starter-web

#### 自定义命名空间

* 后缀："-spring-boot-starter"
* 模式：{module.name}-spring-boot-starter
* 举例：mybatis-spring-boot-starter



## 自动装配经验

* 自动装配实现类名以 “AutoConfiguration” 为后缀
* 组合前置条件尽可能严谨
  * 例如 Spring Boot Web MVC 应用判定
    * 正例
      * `@ConditionalOnWebApplication`
      * `@ConditionalOnClass(Servlet.class)`
      * `@ConditionalOnClass(DispatcherServlet.class)`
    * 反例
      * `ConditionalOnWebApplication`
* 组合前置条件判断成本由低到高
  * 假设当 `@ConditionalOnClass` 和 `@ConditionalOnBean` 同时存在时，`@ConditionalOnClass` 的判断成本较低，因此放置的位置优先
* 自动装配 Class 组件依赖与顺序尽可能明确
* ConfigurationPorperties Class 应生成原信息
  * spring-boot-configuration-processor



## 类库依赖经验

* 明确知晓第三方类库依赖范围
* 类库依赖应做到最小化原则
* 通用工具类尽可能使用 Spring 内部，而非 Apache Commons
* Spring Boot 依赖管理尽量保持 `<optional>ture</optional>`，编译时依赖，运行时不引入

