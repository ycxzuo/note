# 依赖注入

## 依赖注入的模式

### 手动模式

配置或者编程的方式，提前安排注入规则

* XML 资源配置元信息
* Java 注解配置元信息
* API 配置元信息



### 自动模式

实现方提供依赖自动关联的方式，按照内建的注入规则

* Autowiring  （自动绑定）



## 依赖注入的类型

| 依赖注入类型 | 配置元信息举例                                |
| ------------ | --------------------------------------------- |
| Setter 方法  | <property name="user" ref="userBean"/>        |
| 构造器       | <constructor-arg name="user" ref="userBean">  |
| 字段         | @Autowired User user;                         |
| 方法         | @Autowired public void user(User user){...}   |
| 接口回调     | class MyBean implements BeanFactoryAware{...} |



## 自动绑定 Autowiring modes

枚举参考：`org.springframework.beans.factory.annotation.Autowire`

| 模式        | 说明                                                         |
| ----------- | ------------------------------------------------------------ |
| no          | 默认值，未激活 Autowiring，需要手动指定依赖注入对象          |
| byName      | 根据被注入属性的名称作为 Bean 名称进行依赖查找，并将对象设置到该属性 |
| byType      | 根据被注入属性的类型作为依赖类型进行查找，并将对象设置到该属性 |
| constructor | 特殊 byType 类型，用于构造器参数                             |



## Bean 注入

### Setter 方法注入

#### 手动模式

* XML 资源配置元信息
* Java 注解配置元信息
* API 配置元信息



#### 自动模式

* Autowiring  （自动绑定）
  * byName
  * byType



### 构造器注入

#### 手动模式

* XML 资源配置元信息
* Java 注解配置元信息
* API 配置元信息



#### 自动模式

* Autowiring  （自动绑定）
  * constuctor



### 字段注入

#### 手动模式

* Java 注解配置元信息
  * `@Autowired`（默认 byType，不支持 static 修饰的字段）
    * static 字段处理方式：通常通过实例方法注入，然后再通过该方法注入到静态资源，还有一种比较常见，通过 ApplicationContextAware 或 BeanFactoryAware 来操作
  * `@Resource`（默认 byName，不支持 static 修饰的字段）
  * `@Inject`(可选)



### 方法注入

#### 手动模式

Java 注解配置元信息

* `@Autowired`（默认 byType，不支持 static 修饰的字段）
  * static 字段处理方式：通常通过实例方法注入，然后再通过该方法注入到静态资源，还有一种比较常见，通过 `ApplicationContextAware` 或 `BeanFactoryAware` 来操作
* `@Resource`（默认 byName，不支持 static 修饰的字段），**方法调用的时机比 `@Autowired` 早**
* `@Inject`(可选)
* `@Bean`



### 接口回调注入

* Aware 系列接口回调，实现接口就可以拿到内建 Bean 的实例

  * 自动模式

  | 内建接口                       | 说明                                             |
  | ------------------------------ | ------------------------------------------------ |
  | BeanFactoryAware               | 获取当前 IoC 容器 - BeanFactory                  |
  | ApplicationContextAware        | 获取 Spring 应用上下文 - ApplicationContext      |
  | EnvironmentAware               | 获取 Environment                                 |
  | ResourceLoaderAware            | 获取资源加载器 - ResourceLoader                  |
  | BeanClassLoaderAware           | 获取家在当前 Bean Class 的 ClassLoader           |
  | BeanNameAware                  | 获取当前 Bean 名称                               |
  | MessageSourceAware             | 获取 MessageSource，用于国际化                   |
  | ApplicationEventPublisherAware | 获取 ApplicationEventPublisher，用于 Spring 事件 |
  | EmbeddedValueResolverAware     | 获取 SpringValueResolver，用于占位符处理         |



### 基础类型注入

* 原生类型：boolean, byte, char, short, long, int, float, double
* 标量类型：Number, Character, Boolean, Enum, Locale, Charset, Currency, Properties, UUID
* 常规类型：Object, String, TimeZone, Calendar, Optional 等
* Spring 类型：Resource, InputSource, Formatter 等



### 集合类型注入

* 数组类型：原生类型，标量类型，常规类型，Spring 类型
* 集合类型
  * Collection：List, Set(SortedSet, NavigableSet, EnumSet)
  * Map：Properties



### 限定注入

* 使用注解 `@Qualifier` 限定
  * 通过 Bean 名称限定
  * 通过分组限定
* 基于注解 `@Qualifier` 扩展限定
  * 自定义注解 - 如 Spring Cloud 的 `@LoadBalanced` 注解



### 延迟依赖注入

* 使用 API `ObjectFactory` 延迟注入
  * 单一类型
  * 集合类型
* 使用 API `ObjectProvider` 延迟注入（推荐使用）
  * 单一类型
  * 集合类型



## 依赖注入类型选择

* 注入选型
  * 低依赖：构造器注入
  * 多依赖：Setter 注入
  * 便利性：字段注入
  * 声明类：方法注入



## 依赖处理过程

处理判断注入类型

* 入口：`DefaultListableBeanFactory#resolveDependency`
* 依赖描述符：`DependencyDescriptor`
* 自定义绑定候选对象处理器：`AutowireCandidateResolver`



## @Autowired 注入

* 注入过程
  * 元信息解析：`DependencyDescriptor`
  * 依赖查找
  * 依赖注入（字段、方法）